---
# yaml-language-server: $schema=https://raw.githubusercontent.com/zarf-dev/zarf/main/zarf.schema.json
kind: ZarfPackageConfig
metadata:
  name: distro-k0s
  version: "###ZARF_PKG_TMPL_VERSION###"
  source: https://github.com/colonel-byte/zarf-pkg-distro-k0s
  annotations:
    org.opencontainers.image.source: "https://github.com/colonel-byte/zarf-pkg-distro-k0s"
    org.opencontainers.image.description: Zarf package for deploying k0s
components:
  - name: binary
    required: true
    files:
      - source: target/k0s
        target: /var/lib/k0s/bin/k0s
        shasum: "###ZARF_PKG_TMPL_K0S_SHA_AMD64###"
        executable: true
      - source: profile/zarf-pkg-k0s.sh
        target: /etc/profile.d/zarf-pkg-k0s.sh
        executable: true
    only:
      cluster:
        architecture: amd64
    actions:
      onCreate:
        before:
          - cmd: |-
              rm -rf     target
              mkdir -p   target
              curl -L -o target/k0s https://github.com/k0sproject/k0s/releases/download/###ZARF_PKG_TMPL_K0S_VERSION###/k0s-###ZARF_PKG_TMPL_K0S_VERSION###-amd64
              chmod +x   target/k0s
            description: pull k0s binary
  - name: binary
    required: true
    files:
      - source: target/k0s
        target: /var/lib/k0s/bin/k0s
        shasum: "###ZARF_PKG_TMPL_K0S_SHA_ARM64###"
        executable: true
      - source: profile/zarf-pkg-k0s.sh
        target: /etc/profile.d/zarf-pkg-k0s.sh
        executable: true
    only:
      cluster:
        architecture: arm64
    actions:
      onCreate:
        before:
          - cmd: |-
              rm -rf     target
              mkdir -p   target
              curl -L -o target/k0s https://github.com/k0sproject/k0s/releases/download/###ZARF_PKG_TMPL_K0S_VERSION###/k0s-###ZARF_PKG_TMPL_K0S_VERSION###-arm64
              chmod +x   target/k0s
            description: pull k0s binary
  - name: images
    required: true
    only:
      cluster:
        architecture: amd64
    files:
      - target: /var/lib/k0s/images
        source: target
    actions:
      onDeploy:
        before:
          - description: remove existing cached k0sproject images
            cmd: |-
              rm -rf /var/lib/k0s/images/quay.io_k0sproject_*
      onCreate:
        before:
          - description: pull images
            cmd: |-
              rm -rf   target
              mkdir -p target

              for img in `cat ./files/airgap-images-list.txt | sort`; do
                export TAR="$(echo $img | sed -E 's/\//_/g; s/:.+$//g').tar"
                echo "pulling $img"
                ./zarf tools registry pull  --platform "linux/amd64" $img ./target/$TAR
              done
  - name: images
    required: true
    only:
      cluster:
        architecture: arm64
    files:
      - target: /var/lib/k0s/images
        source: target
    actions:
      onDeploy:
        before:
          - description: remove existing cached k0sproject images
            cmd: |-
              rm -rf /var/lib/k0s/images/quay.io_k0sproject_*
      onCreate:
        before:
          - description: pull images
            cmd: |-
              rm -rf   target
              mkdir -p target

              for img in `cat ./files/airgap-images-list.txt | sort`; do
                export TAR="$(echo $img | sed -E 's/\//_/g; s/:.+$//g').tar"
                echo "pulling $img"
                ./zarf tools registry pull  --platform "linux/arm64" $img ./target/$TAR
              done
  - name: cni-cilium-binary
    required: true
    files:
      - source: target/cilium-linux-amd64.tar.gz
        extractPath: cilium
        target: /var/lib/k0s/bin/cilium-cli
        executable: true
    only:
      flavor: cni-cilium
      cluster:
        architecture: amd64
    actions:
      onCreate:
        before:
          - cmd: |-
              rm -rf   target
              mkdir -p target
              echo https://github.com/cilium/cilium-cli/releases/download/###ZARF_PKG_TMPL_CILIUM_CLI_VERSION###/cilium-linux-amd64.tar.gz
              curl -L -o ./target/cilium-linux-amd64.tar.gz https://github.com/cilium/cilium-cli/releases/download/###ZARF_PKG_TMPL_CILIUM_CLI_VERSION###/cilium-linux-amd64.tar.gz
            description: pull cilium-cli tar-ball
  - name: cni-cilium-binary
    required: true
    files:
      - source: target/cilium-linux-arm64.tar.gz
        extractPath: cilium
        target: /var/lib/k0s/bin/cilium-cli
        executable: true
    only:
      flavor: cni-cilium
      cluster:
        architecture: arm64
    actions:
      onCreate:
        before:
          - cmd: |-
              rm -rf   target
              mkdir -p target
              echo https://github.com/cilium/cilium-cli/releases/download/###ZARF_PKG_TMPL_CILIUM_CLI_VERSION###/cilium-linux-arm64.tar.gz
              curl -L -o ./target/cilium-linux-arm64.tar.gz https://github.com/cilium/cilium-cli/releases/download/###ZARF_PKG_TMPL_CILIUM_CLI_VERSION###/cilium-linux-arm64.tar.gz
            description: pull cilium-cli tar-ball
  - name: cni-cilium-images
    required: true
    only:
      flavor: cni-cilium
      cluster:
        architecture: amd64
    files:
      - target: /var/lib/k0s/images
        source: target
    actions:
      onDeploy:
        before:
          - description: remove existing cached cilium images
            cmd: |-
              rm -rf /var/lib/k0s/images/quay.io_cilium_*
      onCreate:
        before:
          - description: pull images
            cmd: |-
              rm -rf   target
              mkdir -p target

              for img in `cat ./files/airgap-images-cilium.txt | grep -iv "#" | sort`; do
                export TAR="$(echo $img | sed -E 's/\//_/g; s/:.+$//g').tar"
                echo "pulling $img"
                ./zarf tools registry pull  --platform "linux/amd64" $img ./target/$TAR
              done
  - name: cni-cilium-images
    required: true
    only:
      flavor: cni-cilium
      cluster:
        architecture: arm64
    files:
      - target: /var/lib/k0s/images
        source: target
    actions:
      onDeploy:
        before:
          - description: remove existing cached cilium images
            cmd: |-
              rm -rf /var/lib/k0s/images/quay.io_cilium_*
      onCreate:
        before:
          - description: pull images
            cmd: |-
              rm -rf   target
              mkdir -p target

              for img in `cat ./files/airgap-images-cilium.txt | grep -iv "#" | sort`; do
                export TAR="$(echo $img | sed -E 's/\//_/g; s/:.+$//g').tar"
                echo "pulling $img"
                ./zarf tools registry pull  --platform "linux/arm64" $img ./target/$TAR
              done
  - name: cni-cilium-charts
    required: true
    only:
      flavor: cni-cilium
    files:
      - target: /var/lib/k0s/charts
        source: target
    actions:
      onDeploy:
        before:
          - description: remove existing cached cilium charts
            cmd: |-
              rm -rf /var/lib/k0s/charts/cilium-*
      onCreate:
        before:
          - description: pull images
            cmd: |-
              rm -rf   target
              mkdir -p target
              helm pull --repo=https://helm.cilium.io/ cilium --version=###ZARF_PKG_TMPL_CILIUM_CHART_VERSION### --destination=target

  - name: k0sctl-binary
    required: false
    files:
      - source: target/k0sctl
        target: /var/lib/k0s/bin/k0sctl
        shasum: "###ZARF_PKG_TMPL_K0SCTL_SHA_AMD64###"
        executable: true
    only:
      cluster:
        architecture: amd64
    actions:
      onCreate:
        before:
          - cmd: |-
              rm -rf     target
              mkdir -p   target
              curl -L -o target/k0sctl https://github.com/k0sproject/k0sctl/releases/download/###ZARF_PKG_TMPL_K0SCTL_VERSION###/k0sctl-linux-amd64
              chmod +x   target/k0sctl
            description: pull k0sctl binary
  - name: k0sctl-binary
    required: false
    files:
      - source: target/k0sctl
        target: /var/lib/k0s/bin/k0sctl
        shasum: "###ZARF_PKG_TMPL_K0SCTL_SHA_ARM64###"
        executable: true
    only:
      cluster:
        architecture: arm64
    actions:
      onCreate:
        before:
          - cmd: |-
              rm -rf     target
              mkdir -p   target
              curl -L -o target/k0sctl https://github.com/k0sproject/k0sctl/releases/download/###ZARF_PKG_TMPL_K0SCTL_VERSION###/k0sctl-linux-arm64
              chmod +x   target/k0sctl
            description: pull k0sctl binary
